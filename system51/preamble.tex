\documentclass[a4paper,twocolumn,oneside]{memoir}

\usepackage[british]{babel}
\usepackage{gurps}
\usepackage{luacode}
\usepackage{libertine}
\usepackage{microtype}
\usepackage{xparse}
\usepackage{multicol}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage{tikz}
\usetikzlibrary{calc,intersections,angles,positioning}
\usepackage{tcolorbox}
\usepackage{transparent}
\renewcommand{\familydefault}{\sfdefault}

\graphicspath{{images/}}

\setulmarginsandblock{1.5cm}{1.5cm}{*}
\setlrmarginsandblock{1.5cm}{1.5cm}{*}
\checkandfixthelayout

\setsecnumdepth{subsubsection}

% Useful macros
\NewDocumentCommand{\system}{m}{\textsc{System#1}}
\NewDocumentCommand{\player}{m}{\textbf{\mbox{#1}}}
\NewDocumentCommand{\thecompany}{}{\textbf{The Company}\xspace}

\NewDocumentCommand{\traititem}{smmm}{\item #2[#3] p.~#4}
\NewDocumentEnvironment{traitlist}{O{List of traits.}o}%
{\begin{figure*}
    \begin{minipage}{1.0\linewidth}
      \begin{multicols}{3}
        \begin{compactitem}}%
        {\end{compactitem}
      \end{multicols}
    \end{minipage}
    \caption{#1}
    \IfValueTF{#2}{\label{#2}}{}
  \end{figure*}}


\newcounter{proposals}
\NewDocumentCommand{\listproposalsname}{}{List of proposals}
\newlistof{listofproposals}{pro}{\listproposalsname}
\NewDocumentEnvironment{proposal}{m}{%
  \refstepcounter{proposals}
  \addcontentsline{pro}{proposals}{#1}
  \noindent
  \textbf{Proposal \theproposals: #1}\hrulefill\par
}{%
  \par\noindent%
  \textbf{End of proposal}\hrulefill%
}


\makeatletter%
\NewDocumentCommand{\InnateAttackPointsPerLevel}{m}{%
  \luadirect{_INNATE_ATTACK.pointsPerLevel = #1}%
  #1~points/level\xspace%
}
\NewDocumentCommand{\InnateAttackLevel}{m}{%
  \luadirect{_INNATE_ATTACK.level = #1}%
  level~#1\xspace%
}

% \newcommand{\gurps@innateattack@percentmodifiers}{0.0}%
\NewDocumentCommand{\InnateAttackPercentModifier}{O{}m}{%
  \luadirect{table.insert(_INNATE_ATTACK.percentModifiers, {
      reason=[[#1]],
      value=#2/100
    })}%
  % \pgfmathsetmacro{\gurps@innateattack@currentpercentmodifier}{#1/100}
  % \let\oldgurps@innateattack@percentmodifiers\gurps@innateattack@percentmodifiers
  % \renewcommand{\gurps@innateattack@percentmodifiers}{%
  %   \oldgurps@innateattack@percentmodifiers, %
  %   \gurps@innateattack@currentpercentmodifier}%
  % \gurps@innateattack@currentpercentmodifier\% (\gurps@innateattack@percentmodifiers)%
  #2\%\xspace%
}

\NewDocumentCommand{\InnateAttackTotalPoints}{}{%
  \luadirect{
    r = _INNATE_ATTACK.level*_INNATE_ATTACK.pointsPerLevel
    percentModifier = 1
    for i,j in pairs(_INNATE_ATTACK.percentModifiers) do
      percentModifier = percentModifier+j.value
    end
    r = r*percentModifier
    tex.sprint(tostring(math.ceil(r)))
  }~points\xspace%
}
\NewDocumentCommand{\InnateAttackBreakdown}{}{
  \newcommand\pc{\%\xspace}
  \begin{tabular}{lc}
    \hline
    Reason & Modifier \\\hline
    \luaexec{
      _pcmodifier = 0
      tex.sprint("(Level &" .. _INNATE_ATTACK.level .. [[)\\]])
      tex.sprint("Points/level & Ã—" .. _INNATE_ATTACK.pointsPerLevel .. [[\\]])
      for i,j in pairs(_INNATE_ATTACK.percentModifiers) do
        if j.value < 0 then
          tex.sprint(j.reason .. [[&]] .. math.floor(j.value*100) .. [[\string\pc \\]])
        else
          tex.sprint(j.reason .. [[& +]] .. math.floor(j.value*100) .. [[\string\pc \\]])
        end
        _pcmodifier = _pcmodifier + j.value*100
      end
    }\hline
    Total & \InnateAttackTotalPoints \\\hline
  \end{tabular}
}
\makeatother%

\NewDocumentEnvironment{innateattack}{}{%
  \luadirect{_INNATE_ATTACK = {
      level=0,
      pointsPerLevel=0,
      percentModifiers={}
    }}%
  \begin{itemize}}{\end{itemize}}

\title{\system{51} source book}
\author{Nathanael~Farley, David~Sumner, et al.}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
